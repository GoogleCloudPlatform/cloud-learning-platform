<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Sample FirebaseUI App</title>
    <script src="https://www.gstatic.com/firebasejs/9.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css" />
    <style>
        #loading-container {
            visibility: visible;
        }

        #firebaseui-auth-container {
            visibility: hidden;
        }
    </style>
    <script type="text/javascript">
        const firebaseConfig = {
            apiKey: "<apiKey>",
            authDomain: "<authDomain>",
            projectId: "<projectId>",
            storageBucket: "<storageBucket>",
            messagingSenderId: "<messagingSenderId>",
            appId: "<appId>"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        // FirebaseUI config.
        let uiConfig = {
            signInOptions: [
                firebase.auth.GoogleAuthProvider.PROVIDER_ID,
            ],
            callbacks: {
                signInSuccessWithAuthResult: function (authResult, redirectUrl) {
                    // let user = authResult.user;
                    // let credential = authResult.credential;
                    // console.log(credential)
                    // let isNewUser = authResult.additionalUserInfo.isNewUser;
                    // let providerId = authResult.additionalUserInfo.providerId;
                    // let operationType = authResult.operationType;
                    // console.log(authResult.user.getIdTokenResult(true).then(data=>data))
                    // Do something with the returned AuthResult.
                    // Return type determines whether we continue the redirect
                    // automatically or whether we leave that to developer to handle.
                    return false;
                },
            }
        };

        // Initialize the FirebaseUI Widget using Firebase.
        let ui = new firebaseui.auth.AuthUI(firebase.auth());
        // The start method will wait until the DOM is loaded.
        ui.start('#firebaseui-auth-container', uiConfig);

        function fetchQueryParam(variable) {
            let query = window.location.search.substring(1);
            let vars = query.split('&');
            for (let i = 0; i < vars.length; i++) {
                let pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return null
        }


        initApp = function () {
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    // User is signed in.
                    // let displayName = user.displayName;
                    // let email = user.email;
                    // let emailVerified = user.emailVerified;
                    // let photoURL = user.photoURL;
                    // let uid = user.uid;
                    // let phoneNumber = user.phoneNumber;
                    // let providerData = user.providerData;
                    const userId = "fr4oI7jFAG5SBhefLQKl"
                    const ltiContentItemId = "sWMKxxbf55nAsojRVxZ7"
                    const url = `https://core-learning-services-dev.cloudpssolutions.com/lti/api/v1/resource-launch-init?lti_content_item_id=${ltiContentItemId}&user_id=${userId}`
                    let idToken = user.getIdToken().then(function (accessToken) {
                        console.log(accessToken)
                        return accessToken
                    });

                    fetch(url, {
                        redirect: 'follow', headers: {
                            Authorization: `Bearer ${idToken}`
                        }
                    }).then(response => {
                        console.log(response)
                        if (response.redirected) {
                            window.location.href = response.url;
                        }
                    })
                } else {
                    document.getElementById("firebaseui-auth-container").style.visibility = "visible";
                    document.getElementById("loading-container").style.visibility = "hidden";
                    console.log("user sign-in required")
                }
            }, function (error) {
                console.log(error);
            });
        };

        window.addEventListener('load', function () {
            initApp()
        });
    </script>
</head>

<body>
    <!-- The surrounding HTML is left untouched by FirebaseUI.
         Your app may use that space for branding, controls and other customizations.-->
    <h1>Welcome to My Awesome App</h1>
    <div id="loading-container">Loading...</div>
    <div id="firebaseui-auth-container"></div>
</body>

</html>