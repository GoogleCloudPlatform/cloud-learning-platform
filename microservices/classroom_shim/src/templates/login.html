<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>{{title}}</title>
  <script src="https://www.gstatic.com/firebasejs/9.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css" />
  <style>
    body {
      background-color: #fffdf5;
      font-family: Lato, sans-serif;
    }
  </style>
  <script type="text/javascript">
    const firebaseConfig = {
      apiKey: '{{ firebase_api_key }}',
      projectId: '{{ project_id }}',
      authDomain: '{{ firebase_auth_domain }}'
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    let ui = null
    initFirebaseUI()
    function initFirebaseUI() {// FirebaseUI config.
      if (ui) {
        ui.reset();
      } else {
        ui = new firebaseui.auth.AuthUI(firebase.auth());
      }
      let uiConfig = {
        signInOptions: [
          {
            provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
            customParameters: {
              // Forces account selection even when one account is available.
              prompt: "select_account"
            }
          }
        ],
        callbacks: {
          signInSuccessWithAuthResult: function (authResult, redirectUrl) {
            let user = authResult.user;
            let token = user._delegate.accessToken
            displayRedirecting()
            axios
              .get('{{redirect_url}}', {
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              })
              .then((response) => {
                if (response.data) {
                  if (response.data.url) {
                    window.open(response.data.url, "_self").focus()
                  } else {
                    displayError("There was a error while redirecting, Redirect url was not received in the response. Please try again.")
                    console.log("No URL found in the response")
                  }
                } else {
                  displayError("There was a error while redirecting, No response received for redirection. Please try again.")
                  console.log("No response data");
                }
              }).catch((err) => {
                console.log("err", err)
                if (err.response.status == 401) {
                  displayError("Access Denied")
                }
                initFirebaseUI()
              })
            return false;
          },
        },
      };

      ui.start('#firebaseui-auth-container', uiConfig);
    }

    function getParameterByName(name, url = window.location.href) {
      name = name.replace(/[\[\]]/g, '\\$&');
      var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function displayRedirecting(text) {
      var displayText = "Redirecting..."
      if (text) {
        displayText = text
      }
      document.getElementById("status").style.display = "block"
      document.getElementById("status").style.color = "black"
      document.getElementById("status").innerText = displayText
    }

    function displayError(text) {
      var displayText = "There was a error while redirecting! Please try again."
      if (text) {
        displayText = text
      }
      document.getElementById("status").style.display = "block"
      document.getElementById("status").style.color = "red"
      document.getElementById("status").innerText = displayText
    }
  </script>
</head>

<body>
  <h1 style="text-align: center; margin-bottom: 2rem">
    Welcome to ASU Study Hall
  </h1>
  <h3 style="text-align: center; margin-bottom: 2rem" id="instruction">Log in to proceed further</h3>
  <p id="status" style="text-align: center; margin-bottom: 2rem; display: none;"></p>

  <div id="firebaseui-auth-container"></div>
</body>

</html>