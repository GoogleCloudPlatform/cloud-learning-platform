<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Assignment launch</title>
    <script src="https://www.gstatic.com/firebasejs/9.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css" />
    <script type="text/javascript">
        const firebaseConfig = {
            apiKey: "AIzaSyDyr4yG7khoWYsteBcYqVy-t00YlCevtkY",
            projectId: "core-learning-services-dev",
            authDomain: "core-learning-services-dev.firebaseapp.com"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        // FirebaseUI config.
        let uiConfig = {
            signInOptions: [
                {
                    provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                    customParameters: {
                        // Forces account selection even when one account
                        // is available.
                        prompt: 'select_account'
                    }
                }
            ],
            callbacks: {
                signInSuccessWithAuthResult: function (authResult, redirectUrl) {
                    let user = authResult.user;
                    console.log(user._delegate.accessToken)
                    let token = user._delegate.accessToken
                    let url = "https://core-learning-services-dev.cloudpssolutions.com/classroom-shim/api/v1/launch-assignment"
                    assignment_id = getParameterByName("assignment_id")
                    if (assignment_id) {
                        url = `${url}?assignment_id=${assignment_id}`
                    }
                    fetch(url, {
                        redirect: "follow", headers: {
                            Authorization: `Bearer ${token}`
                        },
                        mode: 'cors', // no-cors, *cors, same-origin
                        cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                        // credentials: 'same-origin'
                        referrerPolicy: 'no-referrer'
                    }).then(response => {
                        console.log("redirected with response", response)
                        if (response.redirected) {
                            window.location.href = response.url;
                        }
                    })
                    return false;
                },
            },
        };

        // Initialize the FirebaseUI Widget using Firebase.
        let ui = new firebaseui.auth.AuthUI(firebase.auth());
        // The start method will wait until the DOM is loaded.
        ui.start('#firebaseui-auth-container', uiConfig);

        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
    </script>
</head>

<body>
    <h1 style="text-align: center; margin-bottom: 3rem;">You are required to sign in before we proceed further</h1>
    <div id="firebaseui-auth-container"></div>
</body>

</html>